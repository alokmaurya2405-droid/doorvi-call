<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Scanbell ¬∑ Visitor Portal</title>

    <script src="https://download.agora.io/sdk/release/AgoraRTC_N-4.19.0.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/agora-rtm-sdk@1.5.1/index.js"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:opsz,wght@14..32,400;14..32,600;14..32,700;14..32,800&display=swap" rel="stylesheet">

    <style>
        /* ‚îÄ‚îÄ RESET ‚îÄ‚îÄ */
        *, *::before, *::after {
            margin: 0; padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        /* ‚îÄ‚îÄ BASE ‚îÄ‚îÄ */
        html { font-size: 16px; }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: radial-gradient(circle at 10% 20%, #1a1f3c, #0c0f20 80%);
            min-height: 100vh;
            min-height: 100dvh; /* dynamic viewport for mobile */
            display: flex;
            flex-direction: column;
            color: rgba(255, 255, 255, 0.95);
            overflow-x: hidden;
            overflow-y: auto;
            position: relative;
        }

        /* ‚îÄ‚îÄ BACKGROUND ORBS ‚îÄ‚îÄ */
        .orb { position: fixed; border-radius: 50%; filter: blur(80px); z-index: 0; opacity: 0.4; pointer-events: none; }
        .orb-1 { width: min(400px, 60vw); height: min(400px, 60vw); background: #007AFF; top: -10%; right: -10%; animation: float 10s infinite; }
        .orb-2 { width: min(300px, 50vw); height: min(300px, 50vw); background: #5856D6; bottom: -5%; left: -5%; animation: float 12s infinite reverse; }

        @keyframes float {
            0%,100% { transform: translate(0,0); }
            50% { transform: translate(15px, 30px); }
        }

        /* ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ */
        .header {
            position: sticky; top: 0;
            padding: clamp(0.8rem, 2vw, 1.2rem) clamp(1rem, 4vw, 2rem);
            display: flex; align-items: center; justify-content: space-between;
            background: rgba(8, 12, 25, 0.7);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(255,255,255,0.1);
            z-index: 100;
        }

        .logo-group { display: flex; align-items: center; gap: 0.6rem; }
        .logo-icon { font-size: clamp(1.3rem, 4vw, 1.8rem); }
        .logo-text {
            font-size: clamp(1.1rem, 3.5vw, 1.5rem);
            font-weight: 800; letter-spacing: -0.5px;
            background: linear-gradient(135deg, #fff, #bbe1fa);
            -webkit-background-clip: text; color: transparent;
        }

        .house-badge {
            background: rgba(255,255,255,0.1);
            padding: 0.4rem clamp(0.6rem, 2vw, 1.2rem);
            border-radius: 30px;
            font-size: clamp(0.75rem, 2.5vw, 0.9rem);
            font-weight: 700;
            border: 1px solid rgba(255,255,255,0.2);
            color: #007AFF;
        }

        /* ‚îÄ‚îÄ MAIN CONTAINER ‚îÄ‚îÄ */
        .container {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: clamp(1rem, 3vw, 2rem) clamp(1rem, 4vw, 1.5rem);
            z-index: 5;
            gap: 1rem;
        }

        /* ‚îÄ‚îÄ GLASS PANEL ‚îÄ‚îÄ */
        .glass-panel {
            background: rgba(25, 30, 50, 0.45);
            backdrop-filter: blur(25px);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: clamp(1.5rem, 4vw, 2.5rem);
            box-shadow: 0 25px 50px -12px rgba(0,0,0,0.5);
            width: 100%;
            max-width: 520px;
            padding: clamp(1.5rem, 4vw, 2.5rem) clamp(1.2rem, 4vw, 2rem);
            text-align: center;
        }

        /* ‚îÄ‚îÄ WELCOME BANNER ‚îÄ‚îÄ */
        .welcome-banner {
            display: none;
            background: linear-gradient(135deg, rgba(0,122,255,0.25), rgba(88,86,214,0.25));
            border: 1px solid rgba(0,122,255,0.4);
            border-radius: 1rem;
            padding: 0.75rem 1rem;
            margin-bottom: 1.2rem;
            text-align: left;
        }
        .welcome-banner.show { display: block; }
        .wb-label { font-size: 0.65rem; font-weight: 700; color: rgba(255,255,255,0.5); text-transform: uppercase; letter-spacing: 1.5px; margin-bottom: 0.25rem; }
        .wb-name { font-size: 1rem; font-weight: 800; color: #fff; }
        .wb-sub { font-size: 0.72rem; color: rgba(255,255,255,0.5); margin-top: 0.15rem; }

        /* ‚îÄ‚îÄ CAMERA PREVIEW ‚îÄ‚îÄ */
        .camera-preview-container {
            width: clamp(100px, 28vw, 140px);
            height: clamp(100px, 28vw, 140px);
            border-radius: 50%;
            margin: 0 auto 1.2rem;
            background: #000; overflow: hidden;
            border: 3px solid #007AFF;
            box-shadow: 0 0 20px rgba(0,122,255,0.3);
        }
        #preview-video { width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); }

        h1 { font-size: clamp(1.5rem, 5vw, 2.2rem); font-weight: 800; margin-bottom: 0.4rem; color: #fff; }

        .sub-message { font-size: clamp(0.85rem, 2.5vw, 1rem); color: rgba(255,255,255,0.6); margin-bottom: 1.5rem; line-height: 1.5; }

        /* ‚îÄ‚îÄ RING BUTTON ‚îÄ‚îÄ */
        .ring-btn {
            background: linear-gradient(135deg, #007AFF, #0055BB);
            color: white; border: none;
            padding: clamp(0.9rem, 2.5vw, 1.2rem) 2rem;
            border-radius: 1.5rem;
            font-size: clamp(1rem, 3vw, 1.2rem);
            font-weight: 800; width: 100%;
            cursor: pointer; transition: all 0.3s;
            box-shadow: 0 10px 20px rgba(0,122,255,0.3), inset 0 2px 10px rgba(255,255,255,0.2);
            text-transform: uppercase; letter-spacing: 1px;
        }
        .ring-btn:disabled { background: #334155; opacity: 0.6; cursor: not-allowed; box-shadow: none; }
        .ring-btn:active:not(:disabled) { transform: scale(0.97); }

        /* ‚îÄ‚îÄ STATUS FOOTER ‚îÄ‚îÄ */
        .status-footer { margin-top: 1.2rem; font-size: 0.75rem; color: rgba(255,255,255,0.3); text-transform: uppercase; letter-spacing: 2px; }

        /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
           MESSAGING SECTION ‚Äî the new feature
           Shows on pre-call screen so visitor can leave
           a note even without calling
        ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
        .message-panel {
            width: 100%;
            max-width: 520px;
            background: rgba(25, 30, 50, 0.35);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255,255,255,0.08);
            border-radius: clamp(1.5rem, 4vw, 2rem);
            padding: clamp(1.2rem, 3vw, 1.8rem) clamp(1rem, 3vw, 1.5rem);
        }

        .msg-panel-title {
            font-size: clamp(0.85rem, 2.5vw, 1rem);
            font-weight: 800;
            color: rgba(255,255,255,0.8);
            margin-bottom: 0.3rem;
            display: flex; align-items: center; gap: 0.5rem;
        }

        .msg-panel-sub {
            font-size: clamp(0.7rem, 2vw, 0.8rem);
            color: rgba(255,255,255,0.35);
            margin-bottom: 1rem;
        }

        /* Quick message chips */
        .quick-msgs {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .quick-chip {
            background: rgba(255,255,255,0.07);
            border: 1px solid rgba(255,255,255,0.12);
            border-radius: 50px;
            padding: 0.45rem 0.9rem;
            font-size: clamp(0.7rem, 2vw, 0.82rem);
            font-weight: 600;
            color: rgba(255,255,255,0.8);
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
        }
        .quick-chip:hover, .quick-chip:active {
            background: rgba(0,122,255,0.3);
            border-color: rgba(0,122,255,0.6);
            color: #fff;
        }
        .quick-chip.selected {
            background: rgba(0,122,255,0.35);
            border-color: #007AFF;
            color: #fff;
        }

        /* Custom message input area */
        .custom-msg-wrap {
            position: relative;
            margin-bottom: 0.75rem;
        }

        .custom-msg-input {
            width: 100%;
            background: rgba(255,255,255,0.06);
            border: 1px solid rgba(255,255,255,0.12);
            border-radius: 1rem;
            padding: 0.85rem 1rem;
            padding-right: 3rem;
            font-size: clamp(0.82rem, 2.2vw, 0.9rem);
            font-family: 'Inter', sans-serif;
            color: rgba(255,255,255,0.9);
            resize: none;
            outline: none;
            min-height: 52px;
            max-height: 120px;
            transition: border-color 0.2s;
            line-height: 1.4;
        }
        .custom-msg-input::placeholder { color: rgba(255,255,255,0.25); }
        .custom-msg-input:focus { border-color: rgba(0,122,255,0.5); background: rgba(255,255,255,0.08); }

        .char-count {
            position: absolute;
            bottom: 0.5rem; right: 0.75rem;
            font-size: 0.65rem;
            color: rgba(255,255,255,0.25);
            pointer-events: none;
        }
        .char-count.warn { color: #FF9500; }
        .char-count.over { color: #FF3B30; }

        /* Send button */
        .send-msg-btn {
            width: 100%;
            background: rgba(255,255,255,0.07);
            border: 1px solid rgba(255,255,255,0.15);
            border-radius: 1rem;
            padding: 0.85rem;
            font-size: clamp(0.85rem, 2.5vw, 0.95rem);
            font-weight: 700;
            color: rgba(255,255,255,0.7);
            cursor: pointer;
            transition: all 0.25s;
            display: flex; align-items: center; justify-content: center; gap: 0.5rem;
        }
        .send-msg-btn:hover, .send-msg-btn:active {
            background: rgba(0,122,255,0.25);
            border-color: rgba(0,122,255,0.5);
            color: #fff;
        }
        .send-msg-btn:disabled { opacity: 0.35; cursor: not-allowed; }
        .send-msg-btn.sending { background: rgba(0,122,255,0.2); }

        /* Sent confirmation */
        .msg-sent-banner {
            display: none;
            background: rgba(52,199,89,0.15);
            border: 1px solid rgba(52,199,89,0.4);
            border-radius: 0.75rem;
            padding: 0.6rem 1rem;
            font-size: 0.8rem;
            font-weight: 700;
            color: #34C759;
            text-align: center;
            margin-top: 0.5rem;
        }
        .msg-sent-banner.show { display: block; }

        /* ‚îÄ‚îÄ IN-CALL VIDEO LAYOUT ‚îÄ‚îÄ */
        .video-container {
            display: none;
            position: fixed; inset: 0;
            background: #000;
            z-index: 200;
        }
        #remote-video { width: 100%; height: 100%; object-fit: cover; }
        #local-video-small {
            position: absolute; top: 20px; right: 16px;
            width: clamp(80px, 22vw, 110px);
            aspect-ratio: 9/16;
            border-radius: 1rem; overflow: hidden;
            border: 2px solid rgba(255,255,255,0.3);
            box-shadow: 0 10px 20px rgba(0,0,0,0.5);
            background: #1a1f30;
        }

        .call-overlay {
            position: absolute; inset: 0;
            background: rgba(0,0,0,0.6); backdrop-filter: blur(15px);
            display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            z-index: 25; color: white;
            padding: 2rem;
        }

        .status-pill {
            background: rgba(0,122,255,0.2);
            padding: 0.7rem 1.5rem; border-radius: 50px;
            font-size: clamp(1rem, 3vw, 1.2rem);
            font-weight: 700; border: 1px solid #007AFF;
            margin-bottom: 1.5rem; color: #fff;
        }

        .loader {
            width: 48px; height: 48px;
            border: 4px solid rgba(0,122,255,0.2);
            border-top: 4px solid #007AFF;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* Countdown ring */
        .countdown-wrap { margin-top: 1.5rem; display: flex; flex-direction: column; align-items: center; gap: 0.5rem; }
        .countdown-label { font-size: 0.7rem; font-weight: 700; color: rgba(255,255,255,0.4); text-transform: uppercase; letter-spacing: 1.5px; }
        .countdown-ring { position: relative; width: 72px; height: 72px; }
        .countdown-ring svg { transform: rotate(-90deg); }
        .countdown-ring .track { fill: none; stroke: rgba(255,255,255,0.08); stroke-width: 5; }
        .countdown-ring .progress { fill: none; stroke: #FF3B30; stroke-width: 5; stroke-linecap: round; stroke-dasharray: 188.5; stroke-dashoffset: 0; transition: stroke-dashoffset 1s linear; }
        .countdown-number { position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; font-weight: 900; color: #FF3B30; }
        .countdown-sub { font-size: 0.68rem; color: rgba(255,255,255,0.3); text-align: center; max-width: 160px; line-height: 1.4; }

        /* Controls */
        .controls {
            position: absolute; bottom: clamp(24px, 6vh, 44px);
            width: 100%; display: flex; justify-content: center; gap: clamp(1.2rem, 4vw, 2rem);
            z-index: 30;
        }
        .icon-btn {
            width: clamp(58px, 15vw, 70px); height: clamp(58px, 15vw, 70px);
            border-radius: 50%; border: none;
            background: rgba(255,255,255,0.1); backdrop-filter: blur(10px);
            color: white; font-size: clamp(1.4rem, 4vw, 1.8rem);
            cursor: pointer; display: flex; align-items: center; justify-content: center;
            transition: 0.2s; border: 1px solid rgba(255,255,255,0.1);
        }
        .btn-end { background: rgba(255,59,48,0.85); }
        .btn-mute.muted { background: #FF3B30; }

        canvas#snapshot-canvas { display: none; }
        .hidden { display: none !important; }

        /* ‚îÄ‚îÄ QUICK REPLY TOAST (admin's reply shown to visitor) ‚îÄ‚îÄ */
        .admin-reply-toast {
            position: fixed;
            bottom: clamp(100px, 20vh, 140px);
            left: 50%; transform: translateX(-50%);
            background: rgba(0,122,255,0.95);
            color: white;
            padding: 0.75rem 1.4rem;
            border-radius: 50px;
            font-size: clamp(0.85rem, 2.5vw, 1rem);
            font-weight: 700;
            z-index: 300;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
            box-shadow: 0 8px 20px rgba(0,0,0,0.3);
            white-space: nowrap;
            max-width: 90vw;
            overflow: hidden;
            text-overflow: ellipsis;
            animation: toastIn 0.3s ease;
        }
        @keyframes toastIn { from { opacity:0; transform: translateX(-50%) translateY(10px); } to { opacity:1; transform: translateX(-50%) translateY(0); } }

        /* ‚îÄ‚îÄ ENDED / NO-ANSWER SCREEN ‚îÄ‚îÄ */
        .ended-overlay {
            display: none; position: fixed; inset: 0;
            background: radial-gradient(circle at 50% 40%, #1a1f3c, #0c0f20 80%);
            z-index: 300; flex-direction: column;
            align-items: center; justify-content: center;
            text-align: center; padding: 2rem;
        }
        .ended-overlay.show { display: flex; }
        .ended-icon { width: clamp(80px,20vw,100px); height: clamp(80px,20vw,100px); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: clamp(2.2rem,7vw,3rem); margin-bottom: 1.5rem; }
        .ended-icon.admin-ended { background: rgba(255,59,48,0.15); border: 2px solid rgba(255,59,48,0.4); }
        .ended-icon.no-answer { background: rgba(255,149,0,0.15); border: 2px solid rgba(255,149,0,0.4); }
        .ended-icon.rejected { background: rgba(142,142,147,0.15); border: 2px solid rgba(142,142,147,0.4); }
        .ended-title { font-size: clamp(1.4rem,5vw,1.8rem); font-weight: 800; color: #fff; margin-bottom: 0.5rem; }
        .ended-sub { font-size: clamp(0.85rem,2.5vw,1rem); color: rgba(255,255,255,0.5); margin-bottom: 2rem; line-height: 1.6; }
        .ended-btn {
            background: linear-gradient(135deg, #007AFF, #0055BB);
            color: white; border: none;
            padding: 0.9rem 2rem; border-radius: 1.2rem;
            font-size: clamp(0.9rem,2.5vw,1rem); font-weight: 800;
            cursor: pointer; width: 100%; max-width: 280px;
        }

        /* ‚îÄ‚îÄ RESPONSIVE BREAKPOINTS ‚îÄ‚îÄ */
        @media (max-width: 380px) {
            .quick-chip { padding: 0.4rem 0.7rem; font-size: 0.68rem; }
            .glass-panel { padding: 1.2rem 1rem; }
            .message-panel { padding: 1rem 0.9rem; }
        }

        @media (min-width: 600px) {
            .container { justify-content: center; }
            .glass-panel, .message-panel { border-radius: 2rem; }
        }

        @media (max-height: 700px) {
            .camera-preview-container { width: 100px; height: 100px; margin-bottom: 0.8rem; }
            h1 { font-size: 1.5rem; }
            .sub-message { margin-bottom: 1rem; }
        }
    </style>
</head>

<body>
    <div class="orb orb-1"></div>
    <div class="orb orb-2"></div>

    <header class="header">
        <div class="logo-group">
            <span class="logo-icon">üîî</span>
            <span class="logo-text">SCANBELL</span>
        </div>
        <div class="house-badge">House <span id="houseNum">--</span></div>
    </header>

    <main class="container">

        <!-- ‚îÄ‚îÄ PRE-CALL PANEL ‚îÄ‚îÄ -->
        <div class="glass-panel" id="preCall">

            <div class="welcome-banner" id="welcomeBanner">
                <div class="wb-label">üëã Welcome Back</div>
                <div class="wb-name" id="welcomeName">--</div>
                <div class="wb-sub">You're recognized on this device</div>
            </div>

            <div class="camera-preview-container">
                <video id="preview-video" autoplay playsinline muted></video>
            </div>

            <h1>Visitor Access</h1>
            <p class="sub-message">Look at the camera and ring the doorbell.<br>The resident will see you instantly.</p>

            <button class="ring-btn" id="ringBtn" disabled>Connecting...</button>
            <div class="status-footer" id="statusLabel">Initializing RTM...</div>
        </div>

        <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
             LEAVE A MESSAGE PANEL
             Visitor can send a note to admin even
             without making a video call.
        ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
        <div class="message-panel" id="messagePanel">
            <div class="msg-panel-title">
                <span>üí¨</span> Leave a Message
            </div>
            <div class="msg-panel-sub">Not available? Send the resident a quick note.</div>

            <!-- Quick message chips -->
            <div class="quick-msgs" id="quickMsgs">
                <button class="quick-chip" onclick="selectQuickMsg(this, 'I left a package outside. Please collect it.')">üì¶ Package outside</button>
                <button class="quick-chip" onclick="selectQuickMsg(this, 'I will come back later.')">üïê Coming back later</button>
                <button class="quick-chip" onclick="selectQuickMsg(this, 'Please open the door.')">üö™ Open the door</button>
                <button class="quick-chip" onclick="selectQuickMsg(this, 'I have a delivery for you.')">üöö Delivery for you</button>
                <button class="quick-chip" onclick="selectQuickMsg(this, 'Please call me back.')">üìû Call me back</button>
                <button class="quick-chip" onclick="selectQuickMsg(this, 'I left something at your door.')">üì¨ Left something</button>
            </div>

            <!-- Custom message input -->
            <div class="custom-msg-wrap">
                <textarea
                    class="custom-msg-input"
                    id="customMsgInput"
                    placeholder="Or type a custom message..."
                    maxlength="200"
                    rows="2"
                    oninput="onMsgInput(this)"
                ></textarea>
                <span class="char-count" id="charCount">200</span>
            </div>

            <!-- Send button -->
            <button class="send-msg-btn" id="sendMsgBtn" onclick="sendVisitorNote()" disabled>
                <span>üì§</span> Send Message to Resident
            </button>

            <!-- Confirmation -->
            <div class="msg-sent-banner" id="msgSentBanner">
                ‚úÖ Message delivered to resident!
            </div>
        </div>

    </main>

    <!-- ‚îÄ‚îÄ IN-CALL VIDEO ‚îÄ‚îÄ -->
    <div class="video-container" id="videoLayout">
        <div id="remote-video"></div>
        <div id="local-video-small"></div>

        <div class="call-overlay" id="statusOverlay">
            <div class="status-pill">Ringing...</div>
            <div class="loader"></div>
            <div class="countdown-wrap" id="countdownWrap">
                <div class="countdown-label">Auto hang-up in</div>
                <div class="countdown-ring">
                    <svg width="72" height="72" viewBox="0 0 72 72">
                        <circle class="track" cx="36" cy="36" r="30" />
                        <circle class="progress" id="countdownArc" cx="36" cy="36" r="30"
                            stroke-dasharray="188.5" stroke-dashoffset="0" />
                    </svg>
                    <div class="countdown-number" id="countdownNumber">45</div>
                </div>
                <div class="countdown-sub">No answer? Call ends automatically.</div>
            </div>
        </div>

        <div class="controls">
            <button class="icon-btn btn-mute" id="muteBtn" onclick="toggleMute()">üé§</button>
            <button class="icon-btn btn-end" onclick="endSession()">üìû</button>
        </div>
    </div>

    <!-- ‚îÄ‚îÄ ENDED SCREEN ‚îÄ‚îÄ -->
    <div class="ended-overlay" id="endedOverlay">
        <div class="ended-icon" id="endedIcon">üìµ</div>
        <div class="ended-title" id="endedTitle">Call Ended</div>
        <div class="ended-sub" id="endedSub">The resident has ended the call.<br>Thank you for visiting!</div>
        <button class="ended-btn" onclick="location.reload()">Ring Again</button>
    </div>

    <canvas id="snapshot-canvas" width="128" height="128"></canvas>

    <script>
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        //  VISITOR RECOGNITION
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        const VISITOR_ID_KEY   = 'scanbell_visitor_id';
        const VISITOR_NAME_KEY = 'scanbell_visitor_name';

        function getOrCreateVisitorId() {
            let id = localStorage.getItem(VISITOR_ID_KEY);
            if (!id) {
                const ts  = Date.now().toString(36).toUpperCase();
                const rnd = Math.random().toString(36).substr(2, 6).toUpperCase();
                id = `SB_${ts}_${rnd}`;
                localStorage.setItem(VISITOR_ID_KEY, id);
                console.log('[VisitorID] Created:', id);
            } else {
                console.log('[VisitorID] Returning visitor:', id);
            }
            return id;
        }

        function getVisitorName() { return localStorage.getItem(VISITOR_NAME_KEY) || null; }
        function saveVisitorName(name) { if (name && name.trim()) localStorage.setItem(VISITOR_NAME_KEY, name.trim()); }

        function showWelcomeBannerIfKnown() {
            const name = getVisitorName();
            if (name) {
                document.getElementById('welcomeBanner').classList.add('show');
                document.getElementById('welcomeName').innerText = name;
            }
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        //  URL PARAMS
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        const urlParams = new URLSearchParams(window.location.search);
        const appId     = urlParams.get('appid') || '469ff9909237486f8e9bf8526e09899c';

        let houseNo = urlParams.get('houseNo');
        if (!houseNo) {
            const channel = urlParams.get('channelName') || 'house_32_channel';
            houseNo = channel.split('_')[1] || '32';
        }

        const channelName = `house_${houseNo}_channel`;
        const targetId    = `house_${houseNo}`;
        const visitorId   = getOrCreateVisitorId();

        document.getElementById('houseNum').innerText = houseNo;
        showWelcomeBannerIfKnown();

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        //  STATE
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        let rtmClient   = null;
        let rtcClient   = null;
        let localTracks = { video: null, audio: null };
        let signalTimer = null;
        let isMuted     = false;
        let hasAnswered = false;
        let sessionEnded = false;
        let rtmReady    = false; // true once RTM is logged in

        const AUTO_HANGUP_SECONDS = 45;
        const CIRCUMFERENCE       = 188.5;
        let autoHangupInterval    = null;
        let secondsLeft           = AUTO_HANGUP_SECONDS;

        // Track which quick chip is selected
        let selectedQuickMsg = '';

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        //  MESSAGING ‚Äî Quick chip selection
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        function selectQuickMsg(el, text) {
            // Deselect all chips
            document.querySelectorAll('.quick-chip').forEach(c => c.classList.remove('selected'));
            // If clicking already selected chip, deselect (toggle)
            if (selectedQuickMsg === text) {
                selectedQuickMsg = '';
                updateSendBtnState();
                return;
            }
            // Select this chip and fill input
            el.classList.add('selected');
            selectedQuickMsg = text;
            document.getElementById('customMsgInput').value = '';
            updateSendBtnState();
        }

        function onMsgInput(el) {
            // Clear chip selection when typing custom message
            document.querySelectorAll('.quick-chip').forEach(c => c.classList.remove('selected'));
            selectedQuickMsg = '';

            const len = el.value.length;
            const remaining = 200 - len;
            const counter = document.getElementById('charCount');
            counter.innerText = remaining;
            counter.className = 'char-count' + (remaining < 20 ? ' over' : remaining < 50 ? ' warn' : '');

            // Auto-resize textarea
            el.style.height = 'auto';
            el.style.height = Math.min(el.scrollHeight, 120) + 'px';

            updateSendBtnState();
        }

        function updateSendBtnState() {
            const customText = document.getElementById('customMsgInput').value.trim();
            const hasContent = selectedQuickMsg || customText;
            const btn = document.getElementById('sendMsgBtn');
            btn.disabled = !hasContent || !rtmReady;
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        //  SEND VISITOR NOTE TO ADMIN
        //  Sends via RTM as VISITOR_NOTE: prefix
        //  AppContext.js handles it in handleVisitorNote()
        //  which saves to notifications and shows notifee alert
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        async function sendVisitorNote() {
            const customText = document.getElementById('customMsgInput').value.trim();
            const message    = selectedQuickMsg || customText;
            if (!message || !rtmReady) return;

            const btn = document.getElementById('sendMsgBtn');
            btn.disabled = true;
            btn.classList.add('sending');
            btn.innerHTML = '<span>‚è≥</span> Sending...';

            try {
                // RTM message format: VISITOR_NOTE:<message>
                // AppContext.js already handles this exact format
                await rtmClient.sendMessageToPeer(
                    { text: `VISITOR_NOTE:${message}` },
                    targetId
                );
                console.log('[RTM] Note sent:', message);

                // Show success state
                btn.innerHTML = '<span>‚úÖ</span> Message Sent!';
                document.getElementById('msgSentBanner').classList.add('show');

                // Reset after 3 seconds
                setTimeout(() => {
                    btn.innerHTML = '<span>üì§</span> Send Message to Resident';
                    btn.disabled = false;
                    btn.classList.remove('sending');
                    document.getElementById('msgSentBanner').classList.remove('show');
                    // Clear input and selection
                    document.getElementById('customMsgInput').value = '';
                    document.getElementById('customMsgInput').style.height = 'auto';
                    document.querySelectorAll('.quick-chip').forEach(c => c.classList.remove('selected'));
                    selectedQuickMsg = '';
                    document.getElementById('charCount').innerText = '200';
                }, 3000);

            } catch (e) {
                console.error('[RTM] Note send error:', e);
                btn.innerHTML = '<span>‚ùå</span> Failed ‚Äî Try Again';
                btn.disabled = false;
                btn.classList.remove('sending');
                setTimeout(() => { btn.innerHTML = '<span>üì§</span> Send Message to Resident'; }, 2500);
            }
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        //  COUNTDOWN
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        function startAutoHangupCountdown() {
            secondsLeft = AUTO_HANGUP_SECONDS;
            updateCountdownUI(secondsLeft);
            autoHangupInterval = setInterval(() => {
                secondsLeft--;
                updateCountdownUI(secondsLeft);
                if (secondsLeft <= 0) {
                    clearInterval(autoHangupInterval);
                    autoHangupInterval = null;
                    handleNoAnswer();
                }
            }, 1000);
        }

        function stopAutoHangupCountdown() {
            if (autoHangupInterval) { clearInterval(autoHangupInterval); autoHangupInterval = null; }
            const wrap = document.getElementById('countdownWrap');
            if (wrap) wrap.style.display = 'none';
        }

        function updateCountdownUI(secs) {
            document.getElementById('countdownNumber').innerText = secs;
            const offset = CIRCUMFERENCE * (1 - secs / AUTO_HANGUP_SECONDS);
            document.getElementById('countdownArc').style.strokeDashoffset = offset;
            if (secs <= 10) {
                document.getElementById('countdownArc').style.stroke = '#FF9500';
                document.getElementById('countdownNumber').style.color = '#FF9500';
            }
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        //  INIT
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        async function init() {
            try {
                // Camera preview
                const stream = await navigator.mediaDevices.getUserMedia({ video: true });
                document.getElementById('preview-video').srcObject = stream;

                // RTM login
                rtmClient = AgoraRTM.createInstance(appId);
                await rtmClient.login({ uid: visitorId });
                rtmReady = true;

                updateStatus('üü¢ Ready');
                const ringBtn = document.getElementById('ringBtn');
                ringBtn.disabled = false;
                ringBtn.innerText = 'Ring Doorbell';
                updateSendBtnState(); // enable send button now RTM is ready

                rtmClient.on('MessageFromPeer', (message) => {
                    console.log('[RTM] From admin:', message.text);

                    if (message.text === 'CALL_ACCEPTED') {
                        hasAnswered = true;
                        clearInterval(signalTimer);
                        stopAutoHangupCountdown();
                        document.getElementById('statusOverlay').classList.add('hidden');
                        return;
                    }
                    if (message.text === 'CALL_REJECTED') {
                        stopAutoHangupCountdown();
                        cleanupAndShow('rejected');
                        return;
                    }
                    if (message.text === 'CALL_ENDED') {
                        stopAutoHangupCountdown();
                        handleAdminEndedCall();
                        return;
                    }
                    if (message.text.startsWith('QUICK_REPLY:')) {
                        showAdminReplyToast(message.text.replace('QUICK_REPLY:', ''));
                        return;
                    }
                    try {
                        const parsed = JSON.parse(message.text);
                        if (parsed?.event === 'NAME_ASSIGNED' && parsed.name) {
                            saveVisitorName(parsed.name);
                            document.getElementById('welcomeBanner').classList.add('show');
                            document.getElementById('welcomeName').innerText = parsed.name;
                        }
                    } catch (e) { /* not JSON */ }
                });

            } catch (e) {
                console.error('[Init] Error:', e);
                updateStatus('‚ùå Camera Required');
            }
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        //  ADMIN QUICK REPLY TOAST
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        function showAdminReplyToast(text) {
            const old = document.getElementById('adminToast');
            if (old) old.remove();
            const toast = document.createElement('div');
            toast.id = 'adminToast';
            toast.className = 'admin-reply-toast';
            toast.innerText = `üí¨ ${text}`;
            document.body.appendChild(toast);
            setTimeout(() => { if (toast.parentNode) toast.remove(); }, 4000);
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        //  SNAPSHOT
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        function takeSnapshot() {
            const canvas = document.getElementById('snapshot-canvas');
            const video  = document.getElementById('preview-video');
            const ctx    = canvas.getContext('2d');
            if (video.videoWidth > 0) { ctx.drawImage(video, 0, 0, 128, 128); return canvas.toDataURL('image/jpeg', 0.5); }
            return null;
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        //  RING BELL
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        async function ringBell() {
            const snapshot = takeSnapshot();
            document.getElementById('preCall').classList.add('hidden');
            document.getElementById('messagePanel').classList.add('hidden');
            document.getElementById('videoLayout').style.display = 'block';

            startAutoHangupCountdown();

            const visitorName = getVisitorName();
            const payload = JSON.stringify({
                event: 'CALL_REQUEST', image: snapshot,
                visitor_id: visitorId, visitor_name: visitorName || null
            });

            const sendSignal = () => {
                if (hasAnswered) return;
                rtmClient.sendMessageToPeer({ text: payload }, targetId)
                    .then(() => console.log('[RTM] Signal sent'))
                    .catch(e => console.error(e));
            };
            sendSignal();
            signalTimer = setInterval(sendSignal, 4000);

            try {
                rtcClient = AgoraRTC.createClient({ mode: 'rtc', codec: 'vp8' });
                rtcClient.on('user-published', async (user, mediaType) => {
                    await rtcClient.subscribe(user, mediaType);
                    if (mediaType === 'video') user.videoTrack.play('remote-video');
                    if (mediaType === 'audio') user.audioTrack.play();
                });
                [localTracks.audio, localTracks.video] = await AgoraRTC.createMicrophoneAndCameraTracks();
                localTracks.video.play('local-video-small');
                await rtcClient.join(appId, channelName, null, null);
                await rtcClient.publish([localTracks.audio, localTracks.video]);
            } catch (e) { console.error('[RTC]', e); }
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        //  CLEANUP
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        async function cleanupAgora() {
            clearInterval(signalTimer);
            try {
                if (localTracks.video) { localTracks.video.close(); localTracks.video = null; }
                if (localTracks.audio) { localTracks.audio.close(); localTracks.audio = null; }
                if (rtcClient) { await rtcClient.leave(); rtcClient = null; }
            } catch (e) { console.log('[Cleanup]', e); }
        }

        function showEndedScreen(reason) {
            document.getElementById('videoLayout').style.display = 'none';
            document.getElementById('preCall').classList.add('hidden');
            document.getElementById('messagePanel').classList.add('hidden');
            const icon  = document.getElementById('endedIcon');
            const title = document.getElementById('endedTitle');
            const sub   = document.getElementById('endedSub');
            if (reason === 'no-answer') {
                icon.className = 'ended-icon no-answer'; icon.innerText = '‚è∞';
                title.innerText = 'No Answer';
                sub.innerText = 'No answer in 45 seconds.\nPlease try again later.';
            } else if (reason === 'rejected') {
                icon.className = 'ended-icon rejected'; icon.innerText = 'üö´';
                title.innerText = 'Unavailable';
                sub.innerText = 'The resident is currently unavailable.\nPlease try again later.';
            } else {
                icon.className = 'ended-icon admin-ended'; icon.innerText = 'üìµ';
                title.innerText = 'Call Ended';
                sub.innerText = 'The resident has ended the call.\nThank you for visiting!';
            }
            document.getElementById('endedOverlay').classList.add('show');
        }

        async function cleanupAndShow(reason) {
            if (sessionEnded) return;
            sessionEnded = true;
            await cleanupAgora();
            showEndedScreen(reason);
        }

        async function handleAdminEndedCall() { await cleanupAndShow('admin-ended'); }

        async function handleNoAnswer() {
            if (sessionEnded) return;
            sessionEnded = true;
            if (rtmClient) {
                try { await rtmClient.sendMessageToPeer({ text: 'CALL_NO_ANSWER' }, targetId); }
                catch (e) { console.log('[RTM] CALL_NO_ANSWER error:', e); }
            }
            await cleanupAgora();
            showEndedScreen('no-answer');
        }

        function toggleMute() {
            isMuted = !isMuted;
            if (localTracks.audio) localTracks.audio.setEnabled(!isMuted);
            const btn = document.getElementById('muteBtn');
            btn.innerText = isMuted ? 'üîá' : 'üé§';
            btn.classList.toggle('muted', isMuted);
        }

        // UPDATED VISITOR CODE (Fixed)
async function endSession() {
    if (sessionEnded) return;
    sessionEnded = true;
    stopAutoHangupCountdown();

    // ‚îÄ‚îÄ ADD THIS SIGNAL ‚îÄ‚îÄ
    if (rtmClient && !hasAnswered) {
        try {
            // Tell Admin the visitor cancelled/ended the ringing session
            await rtmClient.sendMessageToPeer({ text: 'CALL_NO_ANSWER' }, targetId);
            console.log('[RTM] Sent cancellation signal to Admin');
        } catch (e) {
            console.error('[RTM] Cancel signal failed:', e);
        }
    }

    await cleanupAgora();
    location.reload();
}

        function updateStatus(txt) { document.getElementById('statusLabel').innerText = txt; }

        document.getElementById('ringBtn').onclick = ringBell;
        init();
    </script>
</body>
</html>
